Tags: [[для собеседований]]

#golang 



# Стек, куча
---
&emsp;

## Можно ли точно сказать, в каком месте будет создана переменная: **стек или куча?**
---
&emsp;

Нет, нельзя, все зависит от компилятора и escape-анализатора

Алгоритм эскейпа может меняться от версии к версии


Однако есть нкоторые правила, которые работают почти всегда

![[Screenshot From 2025-10-01 17-32-53.png]]

&emsp;


> [!note] 
> Для последних версий go **1.24+** достаточно даже 1mb

&emsp;

> [!info] 
> Под структурами данных здесь имеются ввиду бакеты (для `map`), массивы (для `slice`), массив битов (для `string`), кольцевой буфер (для `chan`)

&emsp;

> [!tldr] 
> По возможности аллокатор в GO старается разместить переменные на сначала на стеке
> 
> Но уже если анализатор не доказал, что такое размещение нужно, она отправляется в кучу 
> 

&emsp;
## Какая выгода от того, где будет аллоцироваться переменная?
---
&emsp;

Если переменная в куче, то мы будем нагружать GC очисткой кучи от этих самый переменных

Отсюда выполнение ф-ии может замедляться


Если мы передаем жирную переменную по значению, копию останется в стеке, но полностью копируются (все биты одной переменной будут скопированы по-порядку в другом месте памяти)

Это может замедлить ф-ию даже сильнее, чем аллокация в куче

&emsp;
## Чем стек отличается от кучи
---
&emsp;

![[Screenshot From 2025-10-01 18-19-21.png]]

&emsp;
## Устройство стека
---
&emsp;

На каждую горутину выделяется свой стек

Все стеки в контексте GO представляют собой стеки горутин

Стек растет по памяти **от 2КБ до 1Гб (256Мб в 32-битной системе)**

Все ф-ии, вызываемые в горутине, будут в зависимости от очереди вызова аллоцироваться в стеке горутины

![[Screenshot From 2025-10-01 18-29-15.png]]

&emsp;

После каждой аллокации на конце адреса ф-ии размещается **stack pointer**

Сам **frame ф-ии** хранит адрес окончания ф-ии, адрес предыдущего фрейма и локальные переменные

![[Screenshot From 2025-10-01 18-31-22.png]]

&emsp;

Если стек разрастется, например создастся переменная на >2Kb или вызовется рекусрия с большой глубиной, в памяти аллоцируется область под новый стек, куда копируются все фреймы в той же очереди

![[Screenshot From 2025-10-01 18-35-48.png]]


